Parent process ID: 26943 node: 172.31.31.40
24 cutpoints
Stages 1
13 20868437708.800007
7 13915698585.599995
10 17153729331.199993
8 14622140211.200005
9 15846820659.199995
Predicted microbatch size for 1: 8
comm size 0
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 1 7 0 1318861.9384765625 0
End of simulation:  Mini-batch time (usec) = 3575127
Min send: 10000000, max send 0
Min long send: 10000000, max long send 0
Min fwd: 10000000, max fwd 0; min bwd 10000000, max bwd 0
Min long fwd: 125868, max long fwd 129698; min long bwd 191031, max long bwd 199310
Time taken by simulation: 60 microseconds

Stages 2
13 10987980083.2
19 14996390399.999996
22 16963644723.199997
20 15631126630.400002
Predicted microbatch size for 2: 19
comm size 9961472
WARNING: no send time found, 2 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 2 6 0 608928.955078125 542254.6839368516
End of simulation:  Mini-batch time (usec) = 3931026
Min send: 10000000, max send 0
Min long send: 542586, max long send 555338
Min fwd: 106816, max fwd 113936; min bwd 153953, max bwd 157645
Min long fwd: 134083, max long fwd 138708; min long bwd 168934, max long bwd 174223
Time taken by simulation: 130 microseconds

Stages 3
13 7832942284.800001
19 10697074380.8
22 12097432473.599998
23 12575272243.2
24 13035207577.6
Predicted microbatch size for 3: 24
comm size 12582912
WARNING: no send time found, 3 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 3 8 0 399702.3010253906 663682.2411979454
End of simulation:  Mini-batch time (usec) = 5733616
Min send: 10000000, max send 0
Min long send: 663764, max long send 684071
Min fwd: 70710, max fwd 87166; min bwd 113708, max bwd 132902
Min long fwd: 107949, max long fwd 112670; min long bwd 147972, max long bwd 155784
Time taken by simulation: 272 microseconds

Stages 4
13 6255423385.6
19 8547416371.2
22 9664326348.8
23 10045446451.2
24 10412856422.4
Predicted microbatch size for 4: 24
comm size 12582912
WARNING: no send time found, 4 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 4 11 0 298590.2404785156 663682.2411979454
End of simulation:  Mini-batch time (usec) = 7279061
Min send: 10000000, max send 0
Min long send: 663870, max long send 686148
Min fwd: 51765, max fwd 67812; min bwd 85632, max bwd 99460
Min long fwd: 85707, max long fwd 91318; min long bwd 118788, max long bwd 124254
Time taken by simulation: 496 microseconds

Stages 6
13 4698582732.8
19 6397758361.599999
22 7231220224.0
23 7515620659.2
24 7790505267.2
Predicted microbatch size for 6: 24
comm size 12582912
WARNING: no send time found, 6 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 6 15 0 205807.43408203125 663682.2411979454
End of simulation:  Mini-batch time (usec) = 11152793
Min send: 10000000, max send 0
Min long send: 663736, max long send 688387
Min fwd: 32603, max fwd 47172; min bwd 54003, max bwd 69793
Min long fwd: 66617, max long fwd 70492; min long bwd 81618, max long bwd 89601
Time taken by simulation: 1064 microseconds

Stages 8
13 3930501529.6000004
19 5322929356.799999
22 6014667161.6
23 6250707763.2
24 6479329689.6
Predicted microbatch size for 8: 24
comm size 12582912
WARNING: no send time found, 8 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 8 22 0 120660.06469726562 663682.2411979454
End of simulation:  Mini-batch time (usec) = 15792286
Min send: 10000000, max send 0
Min long send: 663682, max long send 690844
Min fwd: 23237, max fwd 38139; min bwd 35712, max bwd 56890
Min long fwd: 51613, max long fwd 57677; min long bwd 69478, max long bwd 76496
Time taken by simulation: 2208 microseconds

Stages 12
13 3141742080.0
19 4248100352.0
22 4798114099.200001
23 4985794867.2
24 5168154112.0
Predicted microbatch size for 12: 24
comm size 12582912
WARNING: no send time found, 12 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 12 43 0 0 663682.2411979454
End of simulation:  Mini-batch time (usec) = 28245316
Min send: 10000000, max send 0
Min long send: 663682, max long send 693511
Min fwd: 10606, max fwd 31119; min bwd 22396, max bwd 41317
Min long fwd: 40838, max long fwd 49874; min long bwd 47936, max long bwd 55473
Time taken by simulation: 6891 microseconds

{1: 3.575127, 2: 3.931026, 3: 5.733616, 4: 7.279061, 6: 11.152793, 8: 15.792286, 12: 28.245316}
{1: 8, 2: 19, 3: 24, 4: 24, 6: 24, 8: 24, 12: 24}
best config is: 2 19
expected time is 3.931026
9 per stage
18 servers!
Config:
ranks: range(9, 10)
train batch size: 1024
partitions: 2
chunk_size: 19
data depth: 9
stage to rank map: 0,2,4,6,8,10,12,14,16;1,3,5,7,9,11,13,15,17;
World size is 18
/opt/conda/envs/varuna/bin/python -u /home/ubuntu/varuna_examples/DeepLearningExamples/PyTorch/LanguageModeling/BERT/run_pretraining.py --rank=9 --chunk_size=19 --local_rank=0 --stage_to_rank_map=0,2,4,6,8,10,12,14,16;1,3,5,7,9,11,13,15,17; --batch-size=113 --input_dir=/hdf5_lower_case_1_seq_len_128_max_pred_20_masked_lm_prob_0.15_random_seed_12345_dupe_factor_5/wikicorpus_en/ --output_dir=s3://spot-checkpoints/bert --config_file=bert_config.json --bert_model=bert-large-uncased --train_batch_size=1024 --max_seq_length=128 --max_predictions_per_seq=20 --max_steps=7038 --warmup_proportion=0.2843 --num_steps_per_checkpoint=200 --learning_rate=6e-3 --seed=12439 --fp16 --gradient_accumulation_steps=128 --allreduce_post_accumulation --allreduce_post_accumulation_fp16 --do_train --json-summary /home/ubuntu/varuna_examples/DeepLearningExamples/PyTorch/LanguageModeling/BERT/results/dllogger.json --varuna
device: cuda:0 n_gpu: 1, distributed training: True, 16-bits training: True
dry run time 0.24433588981628418
SHARED WEIGHTS ARE
[(0, 1)]
this rank  9 is part of pipeline replica  4
6 chunks
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  524288.0
[2022-11-24 14:43:27.788275] Finished iteration 0, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 5694.286
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  262144.0
[2022-11-24 14:43:30.656505] Finished iteration 1, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2867.947
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  131072.0
[2022-11-24 14:43:33.493330] Finished iteration 2, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2836.768
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  65536.0
[2022-11-24 14:43:37.336994] Finished iteration 3, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3843.701
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  32768.0
[2022-11-24 14:43:41.099548] Finished iteration 4, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3762.521
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  16384.0
[2022-11-24 14:43:43.841880] Finished iteration 5, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2742.295
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  8192.0
[2022-11-24 14:43:46.661149] Finished iteration 6, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2819.159
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  4096.0
[2022-11-24 14:43:49.467685] Finished iteration 7, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2806.506
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  2048.0
[2022-11-24 14:43:52.251951] Finished iteration 8, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2784.241
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  1024.0
[2022-11-24 14:43:55.239586] Finished iteration 9, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2987.598
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  512.0
[2022-11-24 14:43:58.027873] Finished iteration 10, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2788.254
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  256.0
[2022-11-24 14:44:00.817126] Finished iteration 11, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2789.194
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  128.0
[2022-11-24 14:44:03.617137] Finished iteration 12, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2799.979
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  64.0
[2022-11-24 14:44:06.458548] Finished iteration 13, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2841.370
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  32.0
[2022-11-24 14:44:09.277454] Finished iteration 14, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2818.912
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  16.0
[2022-11-24 14:44:12.100686] Finished iteration 15, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2823.146
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  8.0
[2022-11-24 14:44:14.904374] Finished iteration 16, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2803.699
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  4.0
[2022-11-24 14:44:17.743390] Finished iteration 17, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2838.960
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  2.0
[2022-11-24 14:44:20.583391] Finished iteration 18, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2839.977
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  1.0
[2022-11-24 14:44:23.373809] Finished iteration 19, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2790.509
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  1.0
[2022-11-24 14:44:26.142891] Finished iteration 20, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2768.902
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  1.0
[2022-11-24 14:44:28.971463] Finished iteration 21, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2828.541
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  1.0
[2022-11-24 14:44:31.799268] Finished iteration 22, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2827.779
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  1.0
[2022-11-24 14:44:34.647114] Finished iteration 23, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2847.970
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  1.0
[2022-11-24 14:44:37.814654] Finished iteration 24, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3167.371
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  1.0
[2022-11-24 14:44:40.613268] Finished iteration 25, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2798.579
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  1.0
[2022-11-24 14:44:43.392493] Finished iteration 26, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2779.168
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  1.0
[2022-11-24 14:44:46.232236] Finished iteration 27, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2839.742
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  1.0
[2022-11-24 14:44:49.034975] Finished iteration 28, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2802.688
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  1.0
[2022-11-24 14:44:51.832010] Finished iteration 29, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2796.972
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  1.0
[2022-11-24 14:44:54.634417] Finished iteration 30, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2802.369
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  1.0
[2022-11-24 14:44:57.471412] Finished iteration 31, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2836.967
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  1.0
[2022-11-24 14:45:00.237313] Finished iteration 32, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2765.901
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  1.0
[2022-11-24 14:45:03.051638] Finished iteration 33, CKPT_AND_STOP: False, flag: tensor([3], dtype=torch.int32), speed: 2814.305
2022-11-24 14:45:03.056191 Begin to save checkpont to s3://spot-checkpoints/bert and exit
Signal handler called with signal 10


 STOPPING VARUNA !!



Rank 9 signal handler called with signal 10
Opt ckpt time 6.5712058544158936
Process done with return code 0
Parent process ID: 29973 node: 172.31.17.44
24 cutpoints
Stages 1
13 20868437708.800007
7 13915698585.599995
10 17153729331.199993
8 14622140211.200005
9 15846820659.199995
Predicted microbatch size for 1: 8
comm size 0
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 1 8 0 1286522.0947265625 0
End of simulation:  Mini-batch time (usec) = 3866112
Min send: 10000000, max send 0
Min long send: 10000000, max long send 0
Min fwd: 10000000, max fwd 0; min bwd 10000000, max bwd 0
Min long fwd: 125868, max long fwd 129698; min long bwd 191031, max long bwd 199310
Time taken by simulation: 56 microseconds

Stages 2
13 10987980083.2
19 14996390399.999996
22 16963644723.199997
20 15631126630.400002
Predicted microbatch size for 2: 19
comm size 9961472
WARNING: no send time found, 2 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 2 7 0 609002.8076171875 542254.6839368516
End of simulation:  Mini-batch time (usec) = 4220388
Min send: 10000000, max send 0
Min long send: 542586, max long send 556277
Min fwd: 106816, max fwd 113936; min bwd 154276, max bwd 159445
Min long fwd: 133244, max long fwd 138708; min long bwd 168934, max long bwd 174223
Time taken by simulation: 149 microseconds

Stages 3
13 7832942284.800001
19 10697074380.8
22 12097432473.599998
23 12575272243.2
24 13035207577.6
Predicted microbatch size for 3: 24
comm size 12582912
WARNING: no send time found, 3 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 3 9 0 391075.1953125 663682.2411979454
End of simulation:  Mini-batch time (usec) = 5984079
Min send: 10000000, max send 0
Min long send: 664014, max long send 688387
Min fwd: 70710, max fwd 87989; min bwd 116815, max bwd 130195
Min long fwd: 106418, max long fwd 113434; min long bwd 146938, max long bwd 153983
Time taken by simulation: 298 microseconds

Stages 4
13 6255423385.6
19 8547416371.2
22 9664326348.8
23 10045446451.2
24 10412856422.4
Predicted microbatch size for 4: 24
comm size 12582912
WARNING: no send time found, 4 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 4 11 0 298590.2404785156 663682.2411979454
End of simulation:  Mini-batch time (usec) = 7279061
Min send: 10000000, max send 0
Min long send: 663870, max long send 686148
Min fwd: 51765, max fwd 67812; min bwd 85632, max bwd 99460
Min long fwd: 85707, max long fwd 91318; min long bwd 118788, max long bwd 124254
Time taken by simulation: 494 microseconds

Stages 6
13 4698582732.8
19 6397758361.599999
22 7231220224.0
23 7515620659.2
24 7790505267.2
Predicted microbatch size for 6: 24
comm size 12582912
WARNING: no send time found, 6 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 6 22 0 139487.73193359375 663682.2411979454
End of simulation:  Mini-batch time (usec) = 13247012
Min send: 10000000, max send 0
Min long send: 663764, max long send 688387
Min fwd: 32840, max fwd 46918; min bwd 55338, max bwd 72497
Min long fwd: 65566, max long fwd 72714; min long bwd 84609, max long bwd 89154
Time taken by simulation: 1589 microseconds

Stages 8
13 3930501529.6000004
19 5322929356.799999
22 6014667161.6
23 6250707763.2
24 6479329689.6
Predicted microbatch size for 8: 24
comm size 12582912
WARNING: no send time found, 8 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 8 22 0 120660.06469726562 663682.2411979454
End of simulation:  Mini-batch time (usec) = 15792286
Min send: 10000000, max send 0
Min long send: 663682, max long send 690844
Min fwd: 23237, max fwd 38139; min bwd 35712, max bwd 56890
Min long fwd: 51613, max long fwd 57677; min long bwd 69478, max long bwd 76496
Time taken by simulation: 2160 microseconds

Stages 12
13 3141742080.0
19 4248100352.0
22 4798114099.200001
23 4985794867.2
24 5168154112.0
Predicted microbatch size for 12: 24
comm size 12582912
WARNING: no send time found, 12 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 12 43 0 0 663682.2411979454
End of simulation:  Mini-batch time (usec) = 28245316
Min send: 10000000, max send 0
Min long send: 663682, max long send 693511
Min fwd: 10606, max fwd 31119; min bwd 22396, max bwd 41317
Min long fwd: 40838, max long fwd 49874; min long bwd 47936, max long bwd 55473
Time taken by simulation: 6972 microseconds

{1: 3.866112, 2: 4.220388, 3: 5.984079, 4: 7.279061, 6: 13.247012, 8: 15.792286, 12: 28.245316}
{1: 8, 2: 19, 3: 24, 4: 24, 6: 24, 8: 24, 12: 24}
best config is: 2 19
expected time is 4.220388
8 per stage
16 servers!
Config:
ranks: range(9, 10)
train batch size: 1024
partitions: 2
chunk_size: 19
data depth: 8
stage to rank map: 0,2,4,6,8,10,12,14;1,3,5,7,9,11,13,15;
World size is 16
/opt/conda/envs/varuna/bin/python -u /home/ubuntu/varuna_examples/DeepLearningExamples/PyTorch/LanguageModeling/BERT/run_pretraining.py --rank=9 --chunk_size=19 --local_rank=0 --stage_to_rank_map=0,2,4,6,8,10,12,14;1,3,5,7,9,11,13,15; --batch-size=128 --input_dir=/hdf5_lower_case_1_seq_len_128_max_pred_20_masked_lm_prob_0.15_random_seed_12345_dupe_factor_5/wikicorpus_en/ --output_dir=s3://spot-checkpoints/bert --config_file=bert_config.json --bert_model=bert-large-uncased --train_batch_size=1024 --max_seq_length=128 --max_predictions_per_seq=20 --max_steps=7038 --warmup_proportion=0.2843 --num_steps_per_checkpoint=200 --learning_rate=6e-3 --seed=12439 --fp16 --gradient_accumulation_steps=128 --allreduce_post_accumulation --allreduce_post_accumulation_fp16 --do_train --json-summary /home/ubuntu/varuna_examples/DeepLearningExamples/PyTorch/LanguageModeling/BERT/results/dllogger.json --varuna --resume_step 34
device: cuda:0 n_gpu: 1, distributed training: True, 16-bits training: True
dry run time 0.12795591354370117
SHARED WEIGHTS ARE
[(0, 1)]
this rank  9 is part of pipeline replica  4
7 chunks
Begin to load checkpint from s3://spot-checkpoints/bert/ckpt_34.pt
2022-11-24 14:46:03.375382 resume step from  34
2022-11-24 14:46:51.540882 - Finished loading checkpoint, takes 48.066 secs
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  524288.0
[2022-11-24 14:47:00.842411] Finished iteration 34, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 6983.766
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  262144.0
[2022-11-24 14:47:03.780719] Finished iteration 35, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 2937.722
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  131072.0
[2022-11-24 14:47:07.929922] Finished iteration 36, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 4149.033
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  65536.0
[2022-11-24 14:47:11.047143] Finished iteration 37, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3117.328
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  32768.0
[2022-11-24 14:47:14.263810] Finished iteration 38, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3216.446
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  16384.0
[2022-11-24 14:47:17.384175] Finished iteration 39, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3120.298
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  8192.0
[2022-11-24 14:47:20.479987] Finished iteration 40, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3095.805
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  4096.0
[2022-11-24 14:47:23.580038] Finished iteration 41, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3099.992
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  2048.0
[2022-11-24 14:47:26.658368] Finished iteration 42, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3078.342
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  1024.0
[2022-11-24 14:47:29.776210] Finished iteration 43, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3117.803
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  512.0
[2022-11-24 14:47:32.892877] Finished iteration 44, CKPT_AND_STOP: False, flag: tensor([3], dtype=torch.int32), speed: 3116.663
2022-11-24 14:47:32.897683 Begin to save checkpont to s3://spot-checkpoints/bert and exit
Signal handler called with signal 10


 STOPPING VARUNA !!



Rank 9 signal handler called with signal 10
Opt ckpt time 5.30621600151062
Process done with return code 0
Parent process ID: 32579 node: 172.31.28.236
24 cutpoints
Stages 1
13 20868437708.800007
7 13915698585.599995
10 17153729331.199993
8 14622140211.200005
9 15846820659.199995
Predicted microbatch size for 1: 8
comm size 0
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 1 9 0 1278524.7802734375 0
End of simulation:  Mini-batch time (usec) = 4182966
Min send: 10000000, max send 0
Min long send: 10000000, max long send 0
Min fwd: 10000000, max fwd 0; min bwd 10000000, max bwd 0
Min long fwd: 125868, max long fwd 130461; min long bwd 191031, max long bwd 199310
Time taken by simulation: 67 microseconds

Stages 2
13 10987980083.2
19 14996390399.999996
22 16963644723.199997
20 15631126630.400002
Predicted microbatch size for 2: 19
comm size 9961472
WARNING: no send time found, 2 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 2 8 0 600510.986328125 542254.6839368516
End of simulation:  Mini-batch time (usec) = 4525989
Min send: 10000000, max send 0
Min long send: 542442, max long send 556435
Min fwd: 107744, max fwd 113936; min bwd 154028, max bwd 157296
Min long fwd: 133001, max long fwd 138295; min long bwd 169394, max long bwd 174223
Time taken by simulation: 165 microseconds

Stages 3
13 7832942284.800001
19 10697074380.8
22 12097432473.599998
23 12575272243.2
24 13035207577.6
Predicted microbatch size for 3: 24
comm size 12582912
WARNING: no send time found, 3 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 3 9 0 391075.1953125 663682.2411979454
End of simulation:  Mini-batch time (usec) = 5984079
Min send: 10000000, max send 0
Min long send: 664014, max long send 688387
Min fwd: 70710, max fwd 87989; min bwd 116815, max bwd 130195
Min long fwd: 106418, max long fwd 113434; min long bwd 146938, max long bwd 153983
Time taken by simulation: 291 microseconds

Stages 4
13 6255423385.6
19 8547416371.2
22 9664326348.8
23 10045446451.2
24 10412856422.4
Predicted microbatch size for 4: 24
comm size 12582912
WARNING: no send time found, 4 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 4 15 0 264588.56201171875 663682.2411979454
End of simulation:  Mini-batch time (usec) = 8956234
Min send: 10000000, max send 0
Min long send: 663870, max long send 688176
Min fwd: 51018, max fwd 67812; min bwd 86129, max bwd 98869
Min long fwd: 83628, max long fwd 91318; min long bwd 119532, max long bwd 124677
Time taken by simulation: 720 microseconds

Stages 6
13 4698582732.8
19 6397758361.599999
22 7231220224.0
23 7515620659.2
24 7790505267.2
Predicted microbatch size for 6: 24
comm size 12582912
WARNING: no send time found, 6 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 6 22 0 139487.73193359375 663682.2411979454
End of simulation:  Mini-batch time (usec) = 13247012
Min send: 10000000, max send 0
Min long send: 663764, max long send 688387
Min fwd: 32840, max fwd 46918; min bwd 55338, max bwd 72497
Min long fwd: 65566, max long fwd 72714; min long bwd 84609, max long bwd 89154
Time taken by simulation: 1608 microseconds

Stages 8
13 3930501529.6000004
19 5322929356.799999
22 6014667161.6
23 6250707763.2
24 6479329689.6
Predicted microbatch size for 8: 24
comm size 12582912
WARNING: no send time found, 8 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 8 43 0 0 663682.2411979454
End of simulation:  Mini-batch time (usec) = 22906615
Min send: 10000000, max send 0
Min long send: 663682, max long send 693511
Min fwd: 20179, max fwd 38698; min bwd 38108, max bwd 56452
Min long fwd: 50555, max long fwd 58723; min long bwd 68720, max long bwd 75958
Time taken by simulation: 4449 microseconds

Stages 12
13 3141742080.0
19 4248100352.0
22 4798114099.200001
23 4985794867.2
24 5168154112.0
Predicted microbatch size for 12: 24
comm size 12582912
WARNING: no send time found, 12 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 12 43 0 0 663682.2411979454
End of simulation:  Mini-batch time (usec) = 28245316
Min send: 10000000, max send 0
Min long send: 663682, max long send 693511
Min fwd: 10606, max fwd 31119; min bwd 22396, max bwd 41317
Min long fwd: 40838, max long fwd 49874; min long bwd 47936, max long bwd 55473
Time taken by simulation: 6905 microseconds

{1: 4.182966, 2: 4.525989, 3: 5.984079, 4: 8.956234, 6: 13.247012, 8: 22.906615, 12: 28.245316}
{1: 8, 2: 19, 3: 24, 4: 24, 6: 24, 8: 24, 12: 24}
best config is: 2 19
expected time is 4.525989
7 per stage
14 servers!
Config:
ranks: range(9, 10)
train batch size: 1024
partitions: 2
chunk_size: 19
data depth: 7
stage to rank map: 0,2,4,6,8,10,12;1,3,5,7,9,11,13;
World size is 14
/opt/conda/envs/varuna/bin/python -u /home/ubuntu/varuna_examples/DeepLearningExamples/PyTorch/LanguageModeling/BERT/run_pretraining.py --rank=9 --chunk_size=19 --local_rank=0 --stage_to_rank_map=0,2,4,6,8,10,12;1,3,5,7,9,11,13; --batch-size=146 --input_dir=/hdf5_lower_case_1_seq_len_128_max_pred_20_masked_lm_prob_0.15_random_seed_12345_dupe_factor_5/wikicorpus_en/ --output_dir=s3://spot-checkpoints/bert --config_file=bert_config.json --bert_model=bert-large-uncased --train_batch_size=1024 --max_seq_length=128 --max_predictions_per_seq=20 --max_steps=7038 --warmup_proportion=0.2843 --num_steps_per_checkpoint=200 --learning_rate=6e-3 --seed=12439 --fp16 --gradient_accumulation_steps=128 --allreduce_post_accumulation --allreduce_post_accumulation_fp16 --do_train --json-summary /home/ubuntu/varuna_examples/DeepLearningExamples/PyTorch/LanguageModeling/BERT/results/dllogger.json --varuna --resume_step 45
device: cuda:0 n_gpu: 1, distributed training: True, 16-bits training: True
dry run time 0.0052700042724609375
SHARED WEIGHTS ARE
[(0, 1)]
this rank  9 is part of pipeline replica  4
8 chunks
Begin to load checkpint from s3://spot-checkpoints/bert/ckpt_45.pt
2022-11-24 14:48:33.751198 resume step from  45
2022-11-24 14:49:26.851258 - Finished loading checkpoint, takes 52.998 secs
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  524288.0
[2022-11-24 14:49:33.713045] Finished iteration 45, CKPT_AND_STOP: False, flag: tensor([4], dtype=torch.int32), speed: 6820.673
2022-11-24 14:49:33.723689 Begin to save checkpont to s3://spot-checkpoints/bert and exit
Signal handler called with signal 10


 STOPPING VARUNA !!



Rank 9 signal handler called with signal 10
Opt ckpt time 10.610368013381958
Process done with return code 0
Parent process ID: 32164 node: 172.31.21.45
24 cutpoints
Stages 1
13 20868437708.800007
7 13915698585.599995
10 17153729331.199993
8 14622140211.200005
9 15846820659.199995
Predicted microbatch size for 1: 8
comm size 0
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 1 10 0 1298431.5185546875 0
End of simulation:  Mini-batch time (usec) = 4527444
Min send: 10000000, max send 0
Min long send: 10000000, max long send 0
Min fwd: 10000000, max fwd 0; min bwd 10000000, max bwd 0
Min long fwd: 125868, max long fwd 130461; min long bwd 191031, max long bwd 199310
Time taken by simulation: 58 microseconds

Stages 2
13 10987980083.2
19 14996390399.999996
22 16963644723.199997
20 15631126630.400002
Predicted microbatch size for 2: 19
comm size 9961472
WARNING: no send time found, 2 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 2 8 0 600510.986328125 542254.6839368516
End of simulation:  Mini-batch time (usec) = 4525989
Min send: 10000000, max send 0
Min long send: 542442, max long send 556435
Min fwd: 107744, max fwd 113936; min bwd 154028, max bwd 157296
Min long fwd: 133001, max long fwd 138295; min long bwd 169394, max long bwd 174223
Time taken by simulation: 175 microseconds

Stages 3
13 7832942284.800001
19 10697074380.8
22 12097432473.599998
23 12575272243.2
24 13035207577.6
Predicted microbatch size for 3: 24
comm size 12582912
WARNING: no send time found, 3 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 3 11 0 367036.0107421875 663682.2411979454
End of simulation:  Mini-batch time (usec) = 6485322
Min send: 10000000, max send 0
Min long send: 663870, max long send 686148
Min fwd: 70710, max fwd 87372; min bwd 114242, max bwd 132372
Min long fwd: 107507, max long fwd 114298; min long bwd 148697, max long bwd 154156
Time taken by simulation: 357 microseconds

Stages 4
13 6255423385.6
19 8547416371.2
22 9664326348.8
23 10045446451.2
24 10412856422.4
Predicted microbatch size for 4: 24
comm size 12582912
WARNING: no send time found, 4 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 4 15 0 264588.56201171875 663682.2411979454
End of simulation:  Mini-batch time (usec) = 8956234
Min send: 10000000, max send 0
Min long send: 663870, max long send 688176
Min fwd: 51018, max fwd 67812; min bwd 86129, max bwd 98869
Min long fwd: 83628, max long fwd 91318; min long bwd 119532, max long bwd 124677
Time taken by simulation: 748 microseconds

Stages 6
13 4698582732.8
19 6397758361.599999
22 7231220224.0
23 7515620659.2
24 7790505267.2
Predicted microbatch size for 6: 24
comm size 12582912
WARNING: no send time found, 6 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 6 22 0 139487.73193359375 663682.2411979454
End of simulation:  Mini-batch time (usec) = 13247012
Min send: 10000000, max send 0
Min long send: 663764, max long send 688387
Min fwd: 32840, max fwd 46918; min bwd 55338, max bwd 72497
Min long fwd: 65566, max long fwd 72714; min long bwd 84609, max long bwd 89154
Time taken by simulation: 1653 microseconds

Stages 8
13 3930501529.6000004
19 5322929356.799999
22 6014667161.6
23 6250707763.2
24 6479329689.6
Predicted microbatch size for 8: 24
comm size 12582912
WARNING: no send time found, 8 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 8 43 0 0 663682.2411979454
End of simulation:  Mini-batch time (usec) = 22906615
Min send: 10000000, max send 0
Min long send: 663682, max long send 693511
Min fwd: 20179, max fwd 38698; min bwd 38108, max bwd 56452
Min long fwd: 50555, max long fwd 58723; min long bwd 68720, max long bwd 75958
Time taken by simulation: 4408 microseconds

Stages 12
13 3141742080.0
19 4248100352.0
22 4798114099.200001
23 4985794867.2
24 5168154112.0
Predicted microbatch size for 12: 24
comm size 12582912
WARNING: no send time found, 12 partitions
GPUS_PER_VM=1 /home/ubuntu/varuna/tools/simulator/simulate-varuna 12 43 0 0 663682.2411979454
End of simulation:  Mini-batch time (usec) = 28245316
Min send: 10000000, max send 0
Min long send: 663682, max long send 693511
Min fwd: 10606, max fwd 31119; min bwd 22396, max bwd 41317
Min long fwd: 40838, max long fwd 49874; min long bwd 47936, max long bwd 55473
Time taken by simulation: 6991 microseconds

{1: 4.527444, 2: 4.525989, 3: 6.485322, 4: 8.956234, 6: 13.247012, 8: 22.906615, 12: 28.245316}
{1: 8, 2: 19, 3: 24, 4: 24, 6: 24, 8: 24, 12: 24}
best config is: 2 19
expected time is 4.525989
7 per stage
14 servers!
Config:
ranks: range(9, 10)
train batch size: 1024
partitions: 2
chunk_size: 19
data depth: 7
stage to rank map: 0,2,4,6,8,10,12;1,3,5,7,9,11,13;
World size is 14
/opt/conda/envs/varuna/bin/python -u /home/ubuntu/varuna_examples/DeepLearningExamples/PyTorch/LanguageModeling/BERT/run_pretraining.py --rank=9 --chunk_size=19 --local_rank=0 --stage_to_rank_map=0,2,4,6,8,10,12;1,3,5,7,9,11,13; --batch-size=146 --input_dir=/hdf5_lower_case_1_seq_len_128_max_pred_20_masked_lm_prob_0.15_random_seed_12345_dupe_factor_5/wikicorpus_en/ --output_dir=s3://spot-checkpoints/bert --config_file=bert_config.json --bert_model=bert-large-uncased --train_batch_size=1024 --max_seq_length=128 --max_predictions_per_seq=20 --max_steps=7038 --warmup_proportion=0.2843 --num_steps_per_checkpoint=200 --learning_rate=6e-3 --seed=12439 --fp16 --gradient_accumulation_steps=128 --allreduce_post_accumulation --allreduce_post_accumulation_fp16 --do_train --json-summary /home/ubuntu/varuna_examples/DeepLearningExamples/PyTorch/LanguageModeling/BERT/results/dllogger.json --varuna --resume_step 46
device: cuda:0 n_gpu: 1, distributed training: True, 16-bits training: True
dry run time 0.24212408065795898
SHARED WEIGHTS ARE
[(0, 1)]
this rank  9 is part of pipeline replica  4
8 chunks
Begin to load checkpint from s3://spot-checkpoints/bert/ckpt_46.pt
2022-11-24 14:50:35.925296 resume step from  46
2022-11-24 14:51:18.967777 - Finished loading checkpoint, takes 43.004 secs
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  524288.0
[2022-11-24 14:51:32.639454] Finished iteration 46, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 6809.401
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  262144.0
[2022-11-24 14:51:37.022969] Finished iteration 47, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 4383.242
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  131072.0
[2022-11-24 14:51:40.393925] Finished iteration 48, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3370.862
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  65536.0
[2022-11-24 14:51:44.774149] Finished iteration 49, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 4380.234
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  32768.0
[2022-11-24 14:51:49.158009] Finished iteration 50, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 4383.989
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  16384.0
[2022-11-24 14:51:52.506071] Finished iteration 51, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3347.766
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  8192.0
[2022-11-24 14:51:55.877964] Finished iteration 52, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3372.069
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  4096.0
[2022-11-24 14:51:59.210061] Finished iteration 53, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3331.849
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  2048.0
[2022-11-24 14:52:02.599122] Finished iteration 54, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3389.039
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  1024.0
[2022-11-24 14:52:05.973642] Finished iteration 55, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3374.477
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  512.0
[2022-11-24 14:52:09.397259] Finished iteration 56, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3423.783
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  256.0
[2022-11-24 14:52:12.766377] Finished iteration 57, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3369.010
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  128.0
[2022-11-24 14:52:16.122612] Finished iteration 58, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3356.179
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  64.0
[2022-11-24 14:52:19.501827] Finished iteration 59, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3379.074
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  32.0
[2022-11-24 14:52:22.863741] Finished iteration 60, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3362.021
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  16.0
[2022-11-24 14:52:26.209347] Finished iteration 61, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3345.392
9 Overflow !!
9 : update_scale(): _has_overflow, dynamic. _loss_scale =  8.0
[2022-11-24 14:52:29.548854] Finished iteration 62, CKPT_AND_STOP: False, flag: tensor([0], dtype=torch.int32), speed: 3339.507
